<!DOCTYPE html>
<html lang="ru">
<head>
<!-- –ü–û–î–ö–õ–Æ–ß–ê–ï–ú –£–¢–ò–õ–ò–¢–´ –ò –ü–†–û–í–ï–†–Ø–ï–ú –ê–í–¢–û–†–ò–ó–ê–¶–ò–Æ -->
<script src="js/utils.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é - –µ—Å–ª–∏ –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –≥–ª–∞–≤–Ω—É—é
    if (!Auth.requireAuth()) return;
    
    console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω:', Auth.currentUser);
    
    // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –¥–ª—è —Å–∫—Ä—ã—Ç–∏—è/–ø–æ–∫–∞–∑–∞ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –ø–æ —Ä–æ–ª—è–º
    if (Auth.isAdmin()) {
      console.log('–†–µ–∂–∏–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞');
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤
      const adminElements = document.querySelectorAll('.admin-only');
      adminElements.forEach(el => el.style.display = 'block');
    } else if (Auth.isManager()) {
      console.log('–†–µ–∂–∏–º —É–ø—Ä–∞–≤–ª—è—é—â–µ–≥–æ');
      // –°–∫—Ä—ã–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è –∞–¥–º–∏–Ω–æ–≤
      const adminElements = document.querySelectorAll('.admin-only');
      adminElements.forEach(el => el.style.display = 'none');
    }
  });
</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üí≥ –ö–∞—Ä—Ç—ã - IP Expense Manager</title>
    <link rel="stylesheet" href="css/style.css">
    <!-- üé® FAVICON -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20'><defs><linearGradient id='borderGrad' x1='0%' y1='0%' x2='100%' y2='100%'><stop offset='0%' stop-color='%238b5cf6'/><stop offset='50%' stop-color='%236d28d9'/><stop offset='100%' stop-color='%231e40af'/></linearGradient><linearGradient id='checkGrad' x1='0%' y1='0%' x2='100%' y2='100%'><stop offset='0%' stop-color='%23a78bfa'/><stop offset='100%' stop-color='%234f46e5'/></linearGradient><filter id='glow' x='-50%' y='-50%' width='200%' height='200%'><feGaussianBlur in='SourceGraphic' stdDeviation='1' result='blur'/><feMerge><feMergeNode in='blur'/><feMergeNode in='SourceGraphic'/></feMerge></filter></defs><circle cx='10' cy='10' r='9' fill='none' stroke='url(%23borderGrad)' stroke-width='1.5' opacity='0.9'/><path d='M6,10 L8.5,12.5 L14,7' stroke='url(%23checkGrad)' stroke-width='2.5' fill='none' stroke-linecap='round' stroke-linejoin='round' filter='url(%23glow)'/></svg>">
    <!-- üîß –ü–û–î–ö–õ–Æ–ß–ê–ï–ú –£–¢–ò–õ–ò–¢–´ -->
    <script src="js/data.js"></script>
    <script src="js/utils.js"></script>
</head>
<body>
    <!-- üéØ –•–ï–î–ï–† -->
    <header class="header">
        <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
<nav class="navbar">
    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <a href="dashboard.html" class="navbar-brand">
                üéØ IP Expense Manager
            </a>
            <div style="display: flex; align-items: center; gap: 20px;">
                <span style="color: white; font-size: 14px;">
                    üëã ${Auth.currentUser?.name} 
                    <span style="opacity: 0.8;">(${Auth.currentUser?.role === 'admin' ? '–ë—É—Ö–≥–∞–ª—Ç–µ—Ä' : '–£–ø—Ä–∞–≤–ª—è—é—â–∏–π'})</span>
                </span>
                <button onclick="Auth.logout()" class="btn" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); font-size: 14px;">
                    üö™ –í—ã–π—Ç–∏
                </button>
            </div>
        </div>
    </div>
</nav>
    </header>

    <main class="container">
        <div class="glass-card animate-slide-in">
            <div class="flex items-center justify-between mb-6" style="flex-wrap: wrap; gap: 16px;">
                <div>
                    <h1 style="margin-bottom: 8px;">üí≥ –ë–∞–Ω–∫–æ–≤—Å–∫–∏–µ –∫–∞—Ä—Ç—ã</h1>
                    <p class="text-muted">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–Ω–∫–æ–≤—Å–∫–∏–º–∏ –∫–∞—Ä—Ç–∞–º–∏ –ø–æ —Ä–µ–≥–∏–æ–Ω–∞–º –∏ –ò–ü</p>
                </div>
                ${isAdmin() ? `
                    <button class="btn btn-primary" onclick="showAddCardForm()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ä—Ç—É</button>
                ` : ''}
            </div>

            <!-- üîç –§–ò–õ–¨–¢–†–´ -->
            <div class="flex gap-4 mb-6" style="flex-wrap: wrap;">
                <div class="form-group" style="flex: 1; min-width: 150px;">
                    <select class="form-select" id="regionFilter" onchange="filterCards()">
                        <option value="">–í—Å–µ —Ä–µ–≥–∏–æ–Ω—ã</option>
                        ${appData.regions.map(region => 
                            `<option value="${region}">${region}</option>`
                        ).join('')}
                    </select>
                </div>
                <div class="form-group" style="flex: 1; min-width: 200px;">
                    <input type="text" class="form-input" id="searchInput" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –ò–ü –∏–ª–∏ –∫–∞—Ä—Ç–µ..." onkeyup="filterCards()">
                </div>
            </div>

            <!-- üìä –ö–ê–†–¢–û–ß–ö–ò –ö–ê–†–¢ -->
            <div id="cardsContainer">
                <!-- –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ JavaScript -->
            </div>
        </div>

        <!-- ‚ú® –§–û–†–ú–ê –î–û–ë–ê–í–õ–ï–ù–ò–Ø/–†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø –ö–ê–†–¢–´ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤) -->
        ${isAdmin() ? `
        <div class="glass-card mt-6 animate-fade-in" id="cardForm" style="display: none;">
            <h3 style="margin-bottom: 20px;" id="formTitle">‚ûï –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –∫–∞—Ä—Ç—É</h3>
            
            <form id="cardFormElement">
                <div class="flex gap-4 mb-6" style="flex-wrap: wrap;">
                    <div class="form-group" style="flex: 1; min-width: 200px;">
                        <label class="form-label">üèôÔ∏è –†–µ–≥–∏–æ–Ω *</label>
                        <select class="form-select" id="cardRegion" required onchange="onCardRegionChange()">
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–≥–∏–æ–Ω...</option>
                            ${appData.regions.map(region => 
                                `<option value="${region}">${region}</option>`
                            ).join('')}
                        </select>
                    </div>
                    
                    <div class="form-group" style="flex: 1; min-width: 200px;">
                        <label class="form-label">üíº –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π –ø—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª—å *</label>
                        <select class="form-select" id="cardIP" required disabled>
                            <option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–≥–∏–æ–Ω</option>
                        </select>
                    </div>
                </div>
                
                <div class="flex gap-4 mb-6" style="flex-wrap: wrap;">
                    <div class="form-group" style="flex: 1; min-width: 200px;">
                        <label class="form-label">üí≥ –ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–∞—è –∫–∞—Ä—Ç–∞</label>
                        <input type="text" class="form-input" id="corpCard" 
                               placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: *1234" maxlength="5">
                    </div>
                    
                    <div class="form-group" style="flex: 1; min-width: 200px;">
                        <label class="form-label">üë§ –ö–∞—Ä—Ç–∞ –§–õ</label>
                        <input type="text" class="form-input" id="flCard" 
                               placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: *5678" maxlength="5">
                    </div>
                </div>
                
                <div class="form-group mb-6">
                    <label class="form-label">üìç –°—Ç–∞—Ç—É—Å –∫–∞—Ä—Ç—ã *</label>
                    <select class="form-select" id="cardStatus" required>
                        <option value="–≤ —Ä–µ–≥–∏–æ–Ω–µ">‚úÖ –í —Ä–µ–≥–∏–æ–Ω–µ</option>
                        <option value="–í –ü–í–ó">üì¶ –í –ü–í–ó</option>
                        <option value="–ü–µ—Ä–µ–≤—ã–ø—É—Å—Ç–∏—Ç—å">üîÑ –ü–µ—Ä–µ–≤—ã–ø—É—Å—Ç–∏—Ç—å</option>
                        <option value="–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞">üö´ –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞</option>
                    </select>
                </div>
                
                <div class="flex gap-4">
                    <button type="submit" class="btn btn-primary" id="submitButton">
                        üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                    </button>
                    <button type="button" class="btn btn-outline" onclick="hideCardForm()">
                        ‚ùå –û—Ç–º–µ–Ω–∞
                    </button>
                </div>
            </form>
        </div>
        ` : ''}
    </main>

    <script>
        let editingCardIP = null;

        function logout() {
            localStorage.removeItem('currentUser');
            appData.currentUser = null;
            showNotification('üëã –î–æ —Å–≤–∏–¥–∞–Ω–∏—è!', 'info');
            setTimeout(() => {
                window.location.href = 'login.html';
            }, 1000);
        }

        function loadCards() {
            const container = document.getElementById('cardsContainer');
            const regionFilter = document.getElementById('regionFilter').value;
            const searchQuery = document.getElementById('searchInput').value.toLowerCase();
            
            let cardsHtml = '';
            
            appData.regions.forEach(region => {
                if (regionFilter && regionFilter !== region) return;
                
                const regionIPs = appData.individualEntrepreneurs[region];
                let regionCardsHtml = '';
                
                regionIPs.forEach(ip => {
                    if (searchQuery && !ip.toLowerCase().includes(searchQuery)) return;
                    
                    const cards = appData.bankCards[ip];
                    if (!cards) return;
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–∏—Å–∫ –ø–æ –Ω–æ–º–µ—Ä—É –∫–∞—Ä—Ç—ã
                    const hasMatchingCard = searchQuery && (
                        (cards.corpCard && cards.corpCard.includes(searchQuery)) ||
                        (cards.flCard && cards.flCard.includes(searchQuery))
                    );
                    
                    if (searchQuery && !hasMatchingCard && !ip.toLowerCase().includes(searchQuery)) return;
                    
                    regionCardsHtml += `
                        <div class="glass-card mb-4">
                            <div class="flex items-start justify-between" style="flex-wrap: wrap; gap: 16px;">
                                <div style="flex: 1; min-width: 300px;">
                                    <h3 style="margin-bottom: 8px; color: var(--primary);">${ip}</h3>
                                    <div class="text-muted mb-3">${region}</div>
                                    
                                    <div class="flex gap-4" style="flex-wrap: wrap;">
                                        ${cards.corpCard ? `
                                            <div class="card-item">
                                                <div style="font-weight: 600; color: var(--success);">üí≥ –ö–æ—Ä–ø. –∫–∞—Ä—Ç–∞</div>
                                                <div style="font-family: monospace; font-size: 1.1rem;">${cards.corpCard}</div>
                                            </div>
                                        ` : ''}
                                        
                                        ${cards.flCard ? `
                                            <div class="card-item">
                                                <div style="font-weight: 600; color: var(--warning);">üë§ –ö–∞—Ä—Ç–∞ –§–õ</div>
                                                <div style="font-family: monospace; font-size: 1.1rem;">${cards.flCard}</div>
                                            </div>
                                        ` : ''}
                                    </div>
                                    
                                    <div class="mt-3">
                                        <span class="badge ${getStatusBadgeClass(cards.status)}">
                                            ${cards.status}
                                        </span>
                                    </div>
                                </div>
                                
                                ${isAdmin() ? `
                                <div class="flex gap-2">
                                    <button class="btn btn-outline" style="padding: 8px 12px;" 
                                            onclick="editCard('${ip}')">
                                        ‚úèÔ∏è
                                    </button>
                                    <button class="btn btn-outline" style="padding: 8px 12px; background: rgba(239, 68, 68, 0.1); color: var(--error);" 
                                            onclick="deleteCard('${ip}')">
                                        üóëÔ∏è
                                    </button>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                });
                
                if (regionCardsHtml) {
                    cardsHtml += `
                        <div class="mb-6">
                            <h2 style="margin-bottom: 16px; padding-bottom: 8px; border-bottom: 2px solid var(--primary);">
                                üèôÔ∏è ${region}
                            </h2>
                            ${regionCardsHtml}
                        </div>
                    `;
                }
            });
            
            container.innerHTML = cardsHtml || `
                <div class="text-center text-muted" style="padding: 60px;">
                    <div style="font-size: 4rem; margin-bottom: 16px;">üí≥</div>
                    <h3 style="margin-bottom: 8px;">–ö–∞—Ä—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
                    <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏</p>
                </div>
            `;
        }

        function getStatusBadgeClass(status) {
            switch (status) {
                case '–≤ —Ä–µ–≥–∏–æ–Ω–µ': return 'badge-success';
                case '–í –ü–í–ó': return 'badge-warning';
                case '–ü–µ—Ä–µ–≤—ã–ø—É—Å—Ç–∏—Ç—å': return 'badge-error';
                default: return 'badge-info';
            }
        }

        function filterCards() {
            loadCards();
        }

        function onCardRegionChange() {
            const region = document.getElementById('cardRegion').value;
            const ipSelect = document.getElementById('cardIP');
            
            if (region) {
                const ips = getIPsByRegion(region);
                ipSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ò–ü...</option>' +
                    ips.map(ip => `<option value="${ip}">${ip}</option>`).join('');
                ipSelect.disabled = false;
            } else {
                ipSelect.innerHTML = '<option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–≥–∏–æ–Ω</option>';
                ipSelect.disabled = true;
            }
        }

        function showAddCardForm() {
            if (!checkAdminAccess()) return;
            
            document.getElementById('cardForm').style.display = 'block';
            document.getElementById('formTitle').textContent = '‚ûï –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –∫–∞—Ä—Ç—É';
            document.getElementById('submitButton').textContent = 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
            editingCardIP = null;
            clearForm('cardFormElement');
        }

        function hideCardForm() {
            document.getElementById('cardForm').style.display = 'none';
            editingCardIP = null;
        }

        function editCard(ip) {
            if (!checkAdminAccess()) return;
            
            const cards = appData.bankCards[ip];
            if (!cards) return;
            
            // –ù–∞—Ö–æ–¥–∏–º —Ä–µ–≥–∏–æ–Ω –ò–ü
            let region = '';
            for (const [reg, ips] of Object.entries(appData.individualEntrepreneurs)) {
                if (ips.includes(ip)) {
                    region = reg;
                    break;
                }
            }
            
            document.getElementById('cardForm').style.display = 'block';
            document.getElementById('formTitle').textContent = `‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ä—Ç—ã: ${ip}`;
            document.getElementById('submitButton').textContent = 'üíæ –û–±–Ω–æ–≤–∏—Ç—å';
            
            document.getElementById('cardRegion').value = region;
            onCardRegionChange(); // –ó–∞–≥—Ä—É–∂–∞–µ–º –ò–ü –¥–ª—è —Ä–µ–≥–∏–æ–Ω–∞
            setTimeout(() => {
                document.getElementById('cardIP').value = ip;
            }, 100);
            
            document.getElementById('corpCard').value = cards.corpCard || '';
            document.getElementById('flCard').value = cards.flCard || '';
            document.getElementById('cardStatus').value = cards.status || '–≤ —Ä–µ–≥–∏–æ–Ω–µ';
            
            editingCardIP = ip;
        }

        function deleteCard(ip) {
            if (!checkAdminAccess()) return;
            
            if (confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∫–∞—Ä—Ç—ã –¥–ª—è –ò–ü "${ip}"?`)) {
                // –ó–¥–µ—Å—å –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–∏–µ –∏–∑ –±—ç–∫–µ–Ω–¥–∞
                showNotification(`üóëÔ∏è –ö–∞—Ä—Ç—ã –¥–ª—è "${ip}" —É–¥–∞–ª–µ–Ω—ã`, 'success');
                loadCards(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã –∫–∞—Ä—Ç—ã
        document.getElementById('cardFormElement')?.addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (!checkAdminAccess()) return;
            
            const formData = {
                region: document.getElementById('cardRegion').value,
                ip: document.getElementById('cardIP').value,
                corpCard: document.getElementById('corpCard').value,
                flCard: document.getElementById('flCard').value,
                status: document.getElementById('cardStatus').value
            };
            
            // –í–∞–ª–∏–¥–∞—Ü–∏—è
            const errors = validateForm(formData, ['region', 'ip', 'status']);
            if (errors.length > 0) {
                errors.forEach(error => showNotification(error, 'error'));
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —É–∫–∞–∑–∞–Ω–∞ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–∞ –∫–∞—Ä—Ç–∞
            if (!formData.corpCard && !formData.flCard) {
                showNotification('‚ùå –£–∫–∞–∂–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –∫–∞—Ä—Ç—É (–∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—É—é –∏–ª–∏ –§–õ)', 'error');
                return;
            }
            
            if (editingCardIP === null) {
                // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π –∫–∞—Ä—Ç—ã
                showNotification(`‚úÖ –ö–∞—Ä—Ç—ã –¥–ª—è "${formData.ip}" –¥–æ–±–∞–≤–ª–µ–Ω—ã`, 'success');
            } else {
                // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π
                showNotification(`‚úÖ –ö–∞—Ä—Ç—ã –¥–ª—è "${formData.ip}" –æ–±–Ω–æ–≤–ª–µ–Ω—ã`, 'success');
            }
            
            hideCardForm();
            loadCards();
        });

        // üîß –ò–ù–ò–¶–ò–ê–õ–ò–ó–ò–†–£–ï–ú –ü–†–ò–õ–û–ñ–ï–ù–ò–ï –ü–†–ò –ó–ê–ì–†–£–ó–ö–ï –°–¢–†–ê–ù–ò–¶–´
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
            if (!appData.currentUser) {
                window.location.href = 'login.html';
                return;
            }
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–∞—Ä—Ç—ã
            loadCards();
        });
    </script>
</body>
</html>