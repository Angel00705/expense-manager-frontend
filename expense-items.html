<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üóÇÔ∏è –°—Ç–∞—Ç—å–∏ —Ä–∞—Å—Ö–æ–¥–æ–≤ - IP Expense Manager</title>
    <link rel="stylesheet" href="css/style.css">
    <!-- üé® FAVICON -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20'><defs><linearGradient id='borderGrad' x1='0%' y1='0%' x2='100%' y2='100%'><stop offset='0%' stop-color='%238b5cf6'/><stop offset='50%' stop-color='%236d28d9'/><stop offset='100%' stop-color='%231e40af'/></linearGradient><linearGradient id='checkGrad' x1='0%' y1='0%' x2='100%' y2='100%'><stop offset='0%' stop-color='%23a78bfa'/><stop offset='100%' stop-color='%234f46e5'/></linearGradient><filter id='glow' x='-50%' y='-50%' width='200%' height='200%'><feGaussianBlur in='SourceGraphic' stdDeviation='1' result='blur'/><feMerge><feMergeNode in='blur'/><feMergeNode in='SourceGraphic'/></feMerge></filter></defs><circle cx='10' cy='10' r='9' fill='none' stroke='url(%23borderGrad)' stroke-width='1.5' opacity='0.9'/><path d='M6,10 L8.5,12.5 L14,7' stroke='url(%23checkGrad)' stroke-width='2.5' fill='none' stroke-linecap='round' stroke-linejoin='round' filter='url(%23glow)'/></svg>">
</head>
<body>
    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
    <nav class="navbar">
        <div class="container">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <a href="dashboard.html" class="navbar-brand">
                    üéØ IP Expense Manager
                </a>
                <div style="display: flex; align-items: center; gap: 20px;">
                    <span style="color: white; font-size: 14px;" id="userInfo">
                        <!-- –ó–∞–ø–æ–ª–Ω–∏—Ç—Å—è —á–µ—Ä–µ–∑ JavaScript -->
                    </span>
                    <button onclick="Auth.logout()" class="btn" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); font-size: 14px;">
                        üö™ –í—ã–π—Ç–∏
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <main class="container" style="padding: 40px 20px;">
        <div class="glass-card animate-slide-in" style="padding: 30px;">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 30px; flex-wrap: wrap; gap: 16px;">
                <div>
                    <h1 style="margin-bottom: 8px; color: var(--primary);">üóÇÔ∏è –°—Ç–∞—Ç—å–∏ —Ä–∞—Å—Ö–æ–¥–æ–≤</h1>
                    <p style="color: var(--text-light); margin: 0;">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏ —Ä–∞—Å—Ö–æ–¥–æ–≤ –∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã—Ö</p>
                </div>
                <button class="btn btn-primary" id="addButton" style="display: none;">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å—Ç–∞—Ç—å—é</button>
            </div>

            <!-- üìä –¢–ê–ë–õ–ò–¶–ê –°–¢–ê–¢–ï–ô –†–ê–°–•–û–î–û–í -->
            <div style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="border-bottom: 2px solid var(--primary);">
                            <th style="text-align: left; padding: 16px; font-weight: 600; color: var(--text-dark);">–°—Ç–∞—Ç—å—è —Ä–∞—Å—Ö–æ–¥–æ–≤</th>
                            <th style="text-align: left; padding: 16px; font-weight: 600; color: var(--text-dark);">–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</th>
                            <th style="text-align: left; padding: 16px; font-weight: 600; color: var(--text-dark);">–ö–æ–ª-–≤–æ –∑–∞–¥–∞—á</th>
                            <th style="text-align: left; padding: 16px; font-weight: 600; color: var(--text-dark);" id="actionsHeader">–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody id="expenseItemsTable">
                        <!-- –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ‚ú® –§–û–†–ú–ê –î–û–ë–ê–í–õ–ï–ù–ò–Ø/–†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤) -->
        <div class="glass-card animate-fade-in" id="expenseForm" style="padding: 30px; margin-top: 30px; display: none;">
            <h3 style="margin-bottom: 20px; color: var(--primary);" id="formTitle">‚ûï –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é —Å—Ç–∞—Ç—å—é —Ä–∞—Å—Ö–æ–¥–æ–≤</h3>
            
            <form id="expenseItemForm">
                <div class="row" style="margin-bottom: 24px;">
                    <div class="col-6">
                        <div class="form-group">
                            <label class="form-label">üè∑Ô∏è –ù–∞–∑–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç—å–∏ *</label>
                            <input type="text" class="form-control" id="expenseItemName" required 
                                   placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: üõí –ü—Ä–æ–¥—É–∫—Ç—ã">
                        </div>
                    </div>
                    
                    <div class="col-6">
                        <div class="form-group">
                            <label class="form-label">üë§ –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π *</label>
                            <select class="form-control form-select" id="expenseItemManager" required>
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ...</option>
                                <option value="–ö—Å–µ–Ω–∏—è –ë.">–ö—Å–µ–Ω–∏—è –ë.</option>
                                <option value="–ü–æ–ª–∏–Ω–∞ –ú.">–ü–æ–ª–∏–Ω–∞ –ú.</option>
                                <option value="–ò–≤–∞–Ω –í.">–ò–≤–∞–Ω –í.</option>
                                <option value="–ò–Ω–Ω–∞ –ë.">–ò–Ω–Ω–∞ –ë.</option>
                                <option value="–ê–ª–µ—Å—è –ë.">–ê–ª–µ—Å—è –ë.</option>
                                <option value="–ï–≤–≥–µ–Ω–∏—è –ì.">–ï–≤–≥–µ–Ω–∏—è –ì.</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 16px;">
                    <button type="submit" class="btn btn-primary" id="submitButton">
                        üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                    </button>
                    <button type="button" class="btn btn-outline" onclick="hideForm()">
                        ‚ùå –û—Ç–º–µ–Ω–∞
                    </button>
                </div>
            </form>
        </div>
    </main>

    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º —Å–∫—Ä–∏–ø—Ç—ã -->
    <script src="js/data.js"></script>
    <script src="js/utils.js"></script>
    <script>
        let editingItemId = null;

        // üîß –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–†–ò –ó–ê–ì–†–£–ó–ö–ï –°–¢–†–ê–ù–ò–¶–´
        document.addEventListener('DOMContentLoaded', function() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
            if (!Auth.requireAuth()) return;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
            updateUserInfo();
            
            // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ø–æ —Ä–æ–ª—è–º
            setupRoleBasedUI();
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç—å–∏ —Ä–∞—Å—Ö–æ–¥–æ–≤
            loadExpenseItems();
        });

        function updateUserInfo() {
            const userInfo = document.getElementById('userInfo');
            if (userInfo && Auth.currentUser) {
                userInfo.innerHTML = `üëã ${Auth.currentUser.name} 
                    <span style="opacity: 0.8;">(${Auth.currentUser.role === 'admin' ? '–ë—É—Ö–≥–∞–ª—Ç–µ—Ä' : '–£–ø—Ä–∞–≤–ª—è—é—â–∏–π'})</span>`;
            }
        }

        function setupRoleBasedUI() {
            const addButton = document.getElementById('addButton');
            const actionsHeader = document.getElementById('actionsHeader');
            
            if (Auth.isAdmin()) {
                if (addButton) addButton.style.display = 'block';
                if (actionsHeader) actionsHeader.style.display = 'table-cell';
            } else {
                if (addButton) addButton.style.display = 'none';
                if (actionsHeader) actionsHeader.style.display = 'none';
            }
        }

        function loadExpenseItems() {
            const tableBody = document.getElementById('expenseItemsTable');
            
            const itemsWithStats = appData.expenseItems.map(item => {
                // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º —Ä–µ–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–¥–∞—á –¥–ª—è —ç—Ç–æ–π —Å—Ç–∞—Ç—å–∏ —Ä–∞—Å—Ö–æ–¥–æ–≤
                const tasks = TaskManager.getAllTasks();
                const taskCount = tasks.filter(task => task.expenseItem === item).length;
                
                return {
                    name: item,
                    manager: appData.managers[item] || '–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω',
                    taskCount: taskCount
                };
            });
            
            tableBody.innerHTML = itemsWithStats.map((item, index) => `
                <tr style="border-bottom: 1px solid var(--border-light); transition: var(--transition);">
                    <td style="padding: 16px;">
                        <div style="font-weight: 600; color: var(--text-dark);">${item.name}</div>
                    </td>
                    <td style="padding: 16px;">
                        <span class="badge badge-info">${item.manager}</span>
                    </td>
                    <td style="padding: 16px;">
                        <span style="font-weight: 600; color: var(--primary);">${item.taskCount}</span>
                    </td>
                    <td style="padding: 16px;" class="actions-cell">
                        ${Auth.isAdmin() ? `
                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-outline" style="padding: 6px 10px;" 
                                    onclick="editExpenseItem(${index}, '${item.name.replace(/'/g, "\\'")}', '${item.manager}')">
                                ‚úèÔ∏è
                            </button>
                            <button class="btn btn-outline" style="padding: 6px 10px; background: rgba(239, 68, 68, 0.1); color: var(--error);" 
                                    onclick="deleteExpenseItem(${index}, '${item.name.replace(/'/g, "\\'")}')">
                                üóëÔ∏è
                            </button>
                        </div>
                        ` : ''}
                    </td>
                </tr>
            `).join('');
        }

        function showAddForm() {
            if (!Auth.isAdmin()) {
                Notification.error('–≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º');
                return;
            }
            
            document.getElementById('expenseForm').style.display = 'block';
            document.getElementById('formTitle').textContent = '‚ûï –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é —Å—Ç–∞—Ç—å—é —Ä–∞—Å—Ö–æ–¥–æ–≤';
            document.getElementById('submitButton').textContent = 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
            editingItemId = null;
            document.getElementById('expenseItemForm').reset();
        }

        function hideForm() {
            document.getElementById('expenseForm').style.display = 'none';
            editingItemId = null;
        }

        function editExpenseItem(id, name, manager) {
            if (!Auth.isAdmin()) {
                Notification.error('–≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º');
                return;
            }
            
            document.getElementById('expenseForm').style.display = 'block';
            document.getElementById('formTitle').textContent = '‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–∞—Ç—å—é —Ä–∞—Å—Ö–æ–¥–æ–≤';
            document.getElementById('submitButton').textContent = 'üíæ –û–±–Ω–æ–≤–∏—Ç—å';
            
            document.getElementById('expenseItemName').value = name;
            document.getElementById('expenseItemManager').value = manager;
            editingItemId = id;
        }

        function deleteExpenseItem(id, name) {
            if (!Auth.isAdmin()) {
                Notification.error('–≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º');
                return;
            }
            
            if (confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ç—å—é —Ä–∞—Å—Ö–æ–¥–æ–≤ "${name}"?`)) {
                // –ó–¥–µ—Å—å –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–∏–µ –∏–∑ –±—ç–∫–µ–Ω–¥–∞
                Notification.success(`üóëÔ∏è –°—Ç–∞—Ç—å—è "${name}" —É–¥–∞–ª–µ–Ω–∞`);
                loadExpenseItems(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Ç–∞–±–ª–∏—Ü—É
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã
        document.getElementById('expenseItemForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (!Auth.isAdmin()) {
                Notification.error('–≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º');
                return;
            }
            
            const formData = {
                name: document.getElementById('expenseItemName').value,
                manager: document.getElementById('expenseItemManager').value
            };
            
            // –í–∞–ª–∏–¥–∞—Ü–∏—è
            if (!formData.name || !formData.manager) {
                Notification.error('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è');
                return;
            }
            
            if (editingItemId === null) {
                // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π —Å—Ç–∞—Ç—å–∏
                Notification.success(`‚úÖ –°—Ç–∞—Ç—å—è "${formData.name}" –¥–æ–±–∞–≤–ª–µ–Ω–∞`);
            } else {
                // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π
                Notification.success(`‚úÖ –°—Ç–∞—Ç—å—è "${formData.name}" –æ–±–Ω–æ–≤–ª–µ–Ω–∞`);
            }
            
            hideForm();
            loadExpenseItems();
        });

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –¥–ª—è –∞–¥–º–∏–Ω–æ–≤
        document.getElementById('addButton').addEventListener('click', showAddForm);
    </script>
</body>
</html>