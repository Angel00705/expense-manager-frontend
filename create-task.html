<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚ûï –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É - IP Expense Manager</title>
    <link rel="stylesheet" href="css/style.css">
    <!-- üé® FAVICON -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20'><defs><linearGradient id='borderGrad' x1='0%' y1='0%' x2='100%' y2='100%'><stop offset='0%' stop-color='%238b5cf6'/><stop offset='50%' stop-color='%236d28d9'/><stop offset='100%' stop-color='%231e40af'/></linearGradient><linearGradient id='checkGrad' x1='0%' y1='0%' x2='100%' y2='100%'><stop offset='0%' stop-color='%23a78bfa'/><stop offset='100%' stop-color='%234f46e5'/></linearGradient><filter id='glow' x='-50%' y='-50%' width='200%' height='200%'><feGaussianBlur in='SourceGraphic' stdDeviation='1' result='blur'/><feMerge><feMergeNode in='blur'/><feMergeNode in='SourceGraphic'/></feMerge></filter></defs><circle cx='10' cy='10' r='9' fill='none' stroke='url(%23borderGrad)' stroke-width='1.5' opacity='0.9'/><path d='M6,10 L8.5,12.5 L14,7' stroke='url(%23checkGrad)' stroke-width='2.5' fill='none' stroke-linecap='round' stroke-linejoin='round' filter='url(%23glow)'/></svg>">
    <!-- üîß –ü–û–î–ö–õ–Æ–ß–ê–ï–ú –£–¢–ò–õ–ò–¢–´ -->
    <script src="js/data.js"></script>
    <script src="js/utils.js"></script>
</head>
<body>
    <!-- üéØ –•–ï–î–ï–† -->
    <header class="header">
        <nav class="nav">
            <div class="logo">
                <span>üí∞</span>
                IP Expense Manager
            </div>
            <div class="nav-links">
                <a href="dashboard.html" class="nav-link">üìä –î–∞—à–±–æ—Ä–¥</a>
                <a href="create-task.html" class="nav-link active">‚ûï –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É</a>
                <a href="tasks.html" class="nav-link">üìã –ó–∞–¥–∞—á–∏</a>
                <a href="expense-items.html" class="nav-link">üóÇÔ∏è –°—Ç–∞—Ç—å–∏ —Ä–∞—Å—Ö–æ–¥–æ–≤</a>
                <a href="cards.html" class="nav-link">üí≥ –ö–∞—Ä—Ç—ã</a>
                <div class="user-info">
                    <!-- –ë—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–æ —á–µ—Ä–µ–∑ JavaScript -->
                </div>
                <button class="btn btn-outline" onclick="logout()">üö™ –í—ã–π—Ç–∏</button>
            </div>
        </nav>
    </header>

    <main class="container">
        <div class="glass-card animate-slide-in">
            <h1 style="margin-bottom: 8px;">‚ûï –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∑–∞–¥–∞—á—É</h1>
            <p class="text-muted">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –Ω–æ–≤–æ–π –∑–∞–¥–∞—á–µ –¥–ª—è —É–ø—Ä–∞–≤–ª—è—é—â–µ–≥–æ</p>

            <form id="createTaskForm" style="margin-top: 30px;">
                <!-- üìç –†–ï–ì–ò–û–ù –ò –ò–ü -->
                <div class="flex gap-4 mb-6" style="flex-wrap: wrap;">
                    <div class="form-group" style="flex: 1; min-width: 200px;">
                        <label class="form-label">üèôÔ∏è –†–µ–≥–∏–æ–Ω *</label>
                        <select class="form-select" id="regionSelect" required onchange="onRegionChange()">
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–≥–∏–æ–Ω...</option>
                            ${appData.regions.map(region => 
                                `<option value="${region}">${region}</option>`
                            ).join('')}
                        </select>
                    </div>

                    <div class="form-group" style="flex: 1; min-width: 200px;">
                        <label class="form-label">üíº –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π –ø—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª—å *</label>
                        <select class="form-select" id="ipSelect" required onchange="onIPChange()" disabled>
                            <option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–≥–∏–æ–Ω</option>
                        </select>
                    </div>
                </div>

                <!-- üí∞ –°–¢–ê–¢–¨–Ø –†–ê–°–•–û–î–û–í –ò –û–¢–í–ï–¢–°–¢–í–ï–ù–ù–´–ô -->
                <div class="flex gap-4 mb-6" style="flex-wrap: wrap;">
                    <div class="form-group" style="flex: 1; min-width: 200px;">
                        <label class="form-label">üìä –°—Ç–∞—Ç—å—è —Ä–∞—Å—Ö–æ–¥–æ–≤ *</label>
                        <select class="form-select" id="expenseItemSelect" required onchange="onExpenseItemChange()">
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ç—å—é —Ä–∞—Å—Ö–æ–¥–æ–≤...</option>
                            ${appData.expenseItems.map(item => 
                                `<option value="${item}">${item}</option>`
                            ).join('')}
                        </select>
                    </div>

                    <div class="form-group" style="flex: 1; min-width: 200px;">
                        <label class="form-label">üë§ –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π —É–ø—Ä–∞–≤–ª—è—é—â–∏–π</label>
                        <input type="text" class="form-input" id="responsibleManager" readonly 
                               placeholder="–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ç—å—é —Ä–∞—Å—Ö–æ–¥–æ–≤">
                    </div>
                </div>

                <!-- üí≥ –ë–ê–ù–ö–û–í–°–ö–ê–Ø –ö–ê–†–¢–ê -->
                <div class="form-group mb-6">
                    <label class="form-label">üí≥ –ë–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞ –¥–ª—è –æ–ø–ª–∞—Ç—ã *</label>
                    <select class="form-select" id="bankCardSelect" required disabled>
                        <option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ò–ü</option>
                    </select>
                    <div class="text-muted" style="margin-top: 8px; font-size: 0.9rem;" id="cardStatus">
                        –°—Ç–∞—Ç—É—Å –∫–∞—Ä—Ç—ã –±—É–¥–µ—Ç –ø–æ–∫–∞–∑–∞–Ω –∑–¥–µ—Å—å
                    </div>
                </div>

                <!-- üìù –û–°–ù–û–í–ù–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø -->
                <div class="flex gap-4 mb-6" style="flex-wrap: wrap;">
                    <div class="form-group" style="flex: 1; min-width: 200px;">
                        <label class="form-label">üè∑Ô∏è –ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ *</label>
                        <input type="text" class="form-input" id="taskTitle" required 
                               placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ó–∞–∫—É–ø–∫–∞ –ø—Ä–æ–¥—É–∫—Ç–æ–≤">
                    </div>

                    <div class="form-group" style="flex: 1; min-width: 200px;">
                        <label class="form-label">üí∞ –ü–ª–∞–Ω–æ–≤–∞—è —Å—É–º–º–∞ *</label>
                        <input type="number" class="form-input" id="plannedAmount" required 
                               placeholder="0.00" step="0.01" min="0">
                    </div>
                </div>

                <!-- üìÖ –î–ê–¢–´ -->
                <div class="flex gap-4 mb-6" style="flex-wrap: wrap;">
                    <div class="form-group" style="flex: 1; min-width: 200px;">
                        <label class="form-label">üìÖ –ü–ª–∞–Ω–æ–≤–∞—è –¥–∞—Ç–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è *</label>
                        <input type="date" class="form-input" id="plannedDate" required>
                    </div>

                    <div class="form-group" style="flex: 1; min-width: 200px;">
                        <label class="form-label">‚è∞ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</label>
                        <select class="form-select" id="prioritySelect">
                            <option value="low">üü¢ –ù–∏–∑–∫–∏–π</option>
                            <option value="medium" selected>üü° –°—Ä–µ–¥–Ω–∏–π</option>
                            <option value="high">üî¥ –í—ã—Å–æ–∫–∏–π</option>
                        </select>
                    </div>
                </div>

                <!-- üìã –û–ü–ò–°–ê–ù–ò–ï -->
                <div class="form-group mb-6">
                    <label class="form-label">üìù –û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏</label>
                    <textarea class="form-textarea" id="taskDescription" 
                              placeholder="–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏, –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏..."></textarea>
                </div>

                <!-- üîß –ö–ù–û–ü–ö–ò -->
                <div class="flex gap-4" style="flex-wrap: wrap;">
                    <button type="submit" class="btn btn-primary">
                        üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–¥–∞—á—É
                    </button>
                    <button type="button" class="btn btn-outline" onclick="clearForm('createTaskForm')">
                        üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å —Ñ–æ—Ä–º—É
                    </button>
                    <a href="tasks.html" class="btn btn-outline">üìã –ö —Å–ø–∏—Å–∫—É –∑–∞–¥–∞—á</a>
                </div>
            </form>
        </div>
    </main>

    <script>
        function onRegionChange() {
            const region = document.getElementById('regionSelect').value;
            const ipSelect = document.getElementById('ipSelect');
            
            if (region) {
                const ips = getIPsByRegion(region);
                ipSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ò–ü...</option>' +
                    ips.map(ip => `<option value="${ip}">${ip}</option>`).join('');
                ipSelect.disabled = false;
            } else {
                ipSelect.innerHTML = '<option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–≥–∏–æ–Ω</option>';
                ipSelect.disabled = true;
                document.getElementById('bankCardSelect').disabled = true;
            }
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º—ã–µ –ø–æ–ª—è
            document.getElementById('bankCardSelect').innerHTML = '<option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ò–ü</option>';
            document.getElementById('cardStatus').textContent = '–°—Ç–∞—Ç—É—Å –∫–∞—Ä—Ç—ã –±—É–¥–µ—Ç –ø–æ–∫–∞–∑–∞–Ω –∑–¥–µ—Å—å';
        }

        function onIPChange() {
            const ip = document.getElementById('ipSelect').value;
            const cardSelect = document.getElementById('bankCardSelect');
            
            if (ip) {
                const cards = getCardsByIP(ip);
                cardSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ä—Ç—É...</option>' +
                    cards.map(card => 
                        `<option value="${card.number}">${card.type} ${card.number}</option>`
                    ).join('');
                cardSelect.disabled = false;
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å –∫–∞—Ä—Ç—ã
                const cardInfo = appData.bankCards[ip];
                if (cardInfo) {
                    document.getElementById('cardStatus').innerHTML = 
                        `<strong>–°—Ç–∞—Ç—É—Å:</strong> ${cardInfo.status}`;
                }
            } else {
                cardSelect.innerHTML = '<option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ò–ü</option>';
                cardSelect.disabled = true;
                document.getElementById('cardStatus').textContent = '–°—Ç–∞—Ç—É—Å –∫–∞—Ä—Ç—ã –±—É–¥–µ—Ç –ø–æ–∫–∞–∑–∞–Ω –∑–¥–µ—Å—å';
            }
        }

        function onExpenseItemChange() {
            const expenseItem = document.getElementById('expenseItemSelect').value;
            const managerField = document.getElementById('responsibleManager');
            
            if (expenseItem) {
                const manager = getManagerByExpenseItem(expenseItem);
                managerField.value = manager;
            } else {
                managerField.value = '';
            }
        }

        function logout() {
            localStorage.removeItem('currentUser');
            appData.currentUser = null;
            showNotification('üëã –î–æ —Å–≤–∏–¥–∞–Ω–∏—è!', 'info');
            setTimeout(() => {
                window.location.href = 'login.html';
            }, 1000);
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
        document.getElementById('createTaskForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (!checkAdminAccess()) return;
            
            const formData = {
                title: document.getElementById('taskTitle').value,
                region: document.getElementById('regionSelect').value,
                ip: document.getElementById('ipSelect').value,
                expenseItem: document.getElementById('expenseItemSelect').value,
                responsibleManager: document.getElementById('responsibleManager').value,
                bankCard: document.getElementById('bankCardSelect').value,
                plannedAmount: parseFloat(document.getElementById('plannedAmount').value),
                plannedDate: document.getElementById('plannedDate').value,
                priority: document.getElementById('prioritySelect').value,
                description: document.getElementById('taskDescription').value,
                status: 'pending',
                createdAt: new Date().toISOString()
            };
            
            // –í–∞–ª–∏–¥–∞—Ü–∏—è
            const errors = validateForm(formData, ['title', 'region', 'ip', 'expenseItem', 'bankCard', 'plannedAmount', 'plannedDate']);
            if (errors.length > 0) {
                errors.forEach(error => showNotification(error, 'error'));
                return;
            }
            
            // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏
            saveTask(formData);
        });

        function saveTask(taskData) {
            // –ó–¥–µ—Å—å –±—É–¥–µ—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –±—ç–∫–µ–Ω–¥–æ–º
            console.log('–°–æ–∑–¥–∞–µ–º –∑–∞–¥–∞—á—É:', taskData);
            showNotification('‚úÖ –ó–∞–¥–∞—á–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!', 'success');
            
            // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
            setTimeout(() => {
                clearForm('createTaskForm');
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º—ã–µ –ø–æ–ª—è
                document.getElementById('ipSelect').innerHTML = '<option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–≥–∏–æ–Ω</option>';
                document.getElementById('ipSelect').disabled = true;
                document.getElementById('bankCardSelect').innerHTML = '<option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ò–ü</option>';
                document.getElementById('bankCardSelect').disabled = true;
                document.getElementById('responsibleManager').value = '';
                document.getElementById('cardStatus').textContent = '–°—Ç–∞—Ç—É—Å –∫–∞—Ä—Ç—ã –±—É–¥–µ—Ç –ø–æ–∫–∞–∑–∞–Ω –∑–¥–µ—Å—å';
            }, 1500);
        }

        // üîß –ò–ù–ò–¶–ò–ê–õ–ò–ó–ò–†–£–ï–ú –ü–†–ò–õ–û–ñ–ï–ù–ò–ï –ü–†–ò –ó–ê–ì–†–£–ó–ö–ï –°–¢–†–ê–ù–ò–¶–´
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
            if (!appData.currentUser) {
                window.location.href = 'login.html';
                return;
            }
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ–≥–æ–¥–Ω—è—à–Ω—é—é –¥–∞—Ç—É –∫–∞–∫ –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('plannedDate').min = today;
            
            // –ï—Å–ª–∏ —Å–µ–≥–æ–¥–Ω—è—à–Ω—è—è –¥–∞—Ç–∞ –≤ –ø—Ä–æ—à–ª–æ–º, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤—Ç—Ä–∞—à–Ω—é—é
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('plannedDate').value = tomorrow.toISOString().split('T')[0];
        });
    </script>
</body>
</html>