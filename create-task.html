<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ - IP Expense Manager</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20'><defs><linearGradient id='borderGrad' x1='0%' y1='0%' x2='100%' y2='100%'><stop offset='0%' stop-color='%238b5cf6'/><stop offset='50%' stop-color='%236d28d9'/><stop offset='100%' stop-color='%231e40af'/></linearGradient><linearGradient id='checkGrad' x1='0%' y1='0%' x2='100%' y2='100%'><stop offset='0%' stop-color='%23a78bfa'/><stop offset='100%' stop-color='%234f46e5'/></linearGradient><filter id='glow' x='-50%' y='-50%' width='200%' height='200%'><feGaussianBlur in='SourceGraphic' stdDeviation='1' result='blur'/><feMerge><feMergeNode in='blur'/><feMergeNode in='SourceGraphic'/></feMerge></filter></defs><circle cx='10' cy='10' r='9' fill='none' stroke='url(%23borderGrad)' stroke-width='1.5' opacity='0.9'/><path d='M6,10 L8.5,12.5 L14,7' stroke='url(%23checkGrad)' stroke-width='2.5' fill='none' stroke-linecap='round' stroke-linejoin='round' filter='url(%23glow)'/></svg>">
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <a href="dashboard.html" class="navbar-brand">
                    üéØ IP Expense Manager
                </a>
                <div style="display: flex; align-items: center; gap: 20px;">
                    <span style="color: white; font-size: 14px;" id="userInfo">
                        <!-- –ó–∞–ø–æ–ª–Ω–∏—Ç—Å—è —á–µ—Ä–µ–∑ JavaScript -->
                    </span>
                    <button onclick="Auth.logout()" class="btn" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); font-size: 14px;">
                        üö™ –í—ã–π—Ç–∏
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="container" style="padding: 40px 20px;">
        <div class="glass-card" style="max-width: 800px; margin: 0 auto; padding: 40px;">
            <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 32px;">
                <a href="dashboard.html" class="btn btn-outline" style="text-decoration: none;">‚Üê –ù–∞–∑–∞–¥</a>
                <h1 style="margin: 0;">üìã –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∑–∞–¥–∞—á–∏</h1>
            </div>

            <form id="createTaskForm">
                <div class="glass-card" style="padding: 24px; margin-bottom: 24px;">
                    <h3 style="margin-bottom: 20px; color: var(--primary);">üìù –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
                    
                    <div class="form-group">
                        <label class="form-label">üéØ –ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ *</label>
                        <input type="text" class="form-control" id="taskTitle" 
                               placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ó–∞–∫—É–ø–∫–∞ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –Ω–∞ –Ω–µ–¥–µ–ª—é" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">üìÑ –û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏</label>
                        <textarea class="form-control" id="taskDescription" 
                                  placeholder="–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏..." 
                                  rows="3"></textarea>
                    </div>
                </div>

                <div class="glass-card" style="padding: 24px; margin-bottom: 24px;">
                    <h3 style="margin-bottom: 20px; color: var(--primary);">üè¢ –í—ã–±–æ—Ä –æ–±—ä–µ–∫—Ç–∞</h3>
                    
                    <div class="row">
                        <div class="col-4">
                            <div class="form-group">
                                <label class="form-label">üìç –†–µ–≥–∏–æ–Ω *</label>
                                <select class="form-control form-select" id="regionSelect" required>
                                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–≥–∏–æ–Ω</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="col-4">
                            <div class="form-group">
                                <label class="form-label">üë§ –ò–ü *</label>
                                <select class="form-control form-select" id="ipSelect" disabled required>
                                    <option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–≥–∏–æ–Ω</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="col-4">
                            <div class="form-group">
                                <label class="form-label">üí≥ –ë–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞ *</label>
                                <select class="form-control form-select" id="cardSelect" disabled required>
                                    <option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ò–ü</option>
                                </select>
                                <small id="cardStatus" style="display: block; margin-top: 4px; color: var(--text-light);"></small>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="glass-card" style="padding: 24px; margin-bottom: 24px;">
                    <h3 style="margin-bottom: 20px; color: var(--primary);">üí∞ –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
                    
                    <div class="row">
                        <div class="col-6">
                            <div class="form-group">
                                <label class="form-label">üìä –°—Ç–∞—Ç—å—è —Ä–∞—Å—Ö–æ–¥–æ–≤ *</label>
                                <select class="form-control form-select" id="expenseSelect" required>
                                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ç—å—é —Ä–∞—Å—Ö–æ–¥–æ–≤</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="col-6">
                            <div class="form-group">
                                <label class="form-label">üë• –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π *</label>
                                <input type="text" class="form-control" id="responsibleManager" 
                                       readonly placeholder="–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ç—å—é —Ä–∞—Å—Ö–æ–¥–æ–≤">
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-6">
                            <div class="form-group">
                                <label class="form-label">üíµ –ü–ª–∞–Ω–æ–≤–∞—è —Å—É–º–º–∞ *</label>
                                <input type="number" class="form-control" id="plannedAmount" 
                                       placeholder="0" min="0" step="0.01" required>
                            </div>
                        </div>
                        
                        <div class="col-6">
                            <div class="form-group">
                                <label class="form-label">üìÖ –ü–ª–∞–Ω–æ–≤–∞—è –¥–∞—Ç–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è *</label>
                                <input type="date" class="form-control" id="plannedDate" required>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="glass-card" style="padding: 24px; margin-bottom: 32px;">
                    <h3 style="margin-bottom: 20px; color: var(--primary);">üìé –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ</h3>
                    
                    <div class="form-group">
                        <label class="form-label">üéØ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</label>
                        <select class="form-control form-select" id="prioritySelect">
                            <option value="low">üîµ –ù–∏–∑–∫–∏–π</option>
                            <option value="medium" selected>üü° –°—Ä–µ–¥–Ω–∏–π</option>
                            <option value="high">üî¥ –í—ã—Å–æ–∫–∏–π</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–ª—è —É–ø—Ä–∞–≤–ª—è—é—â–µ–≥–æ</label>
                        <textarea class="form-control" id="managerComment" 
                                  placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª—è—é—â–µ–≥–æ..." 
                                  rows="2"></textarea>
                    </div>
                </div>

                <div style="display: flex; gap: 16px; justify-content: flex-end;">
                    <button type="button" onclick="window.history.back()" class="btn btn-outline">
                        ‚ùå –û—Ç–º–µ–Ω–∞
                    </button>
                    <button type="submit" class="btn btn-primary">
                        ‚úÖ –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script src="js/data.js"></script>
    <script src="js/utils.js"></script>
    <script>
// –ü—Ä–æ–≤–µ—Ä—è–µ–º —à–∞–±–ª–æ–Ω
const urlParams = new URLSearchParams(window.location.search);
const templateKey = urlParams.get('template');

if (templateKey && appData.taskTemplates[templateKey]) {
    const template = appData.taskTemplates[templateKey];
    
    // –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã –∏–∑ —à–∞–±–ª–æ–Ω–∞
    document.getElementById('taskTitle').value = template.title;
    document.getElementById('taskDescription').value = template.description || '';
    document.getElementById('expenseSelect').value = template.expenseItem;
    document.getElementById('plannedAmount').value = template.plannedAmount;
    document.getElementById('prioritySelect').value = template.priority || 'medium';
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞
    updateResponsibleManager(template.expenseItem);
    
    Notification.success(`–®–∞–±–ª–æ–Ω "${template.title}" –∑–∞–≥—Ä—É–∂–µ–Ω!`);
}
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üìù –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á–∏ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...');
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
            Auth.init();
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
            if (!Auth.requireAuth()) return;
            
            // –¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω—ã –º–æ–≥—É—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å –∑–∞–¥–∞—á–∏
            if (!Auth.isAdmin()) {
                Notification.error('–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –º–æ–≥—É—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å –∑–∞–¥–∞—á–∏');
                setTimeout(() => {
                    window.location.href = 'dashboard.html';
                }, 2000);
                return;
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
            updateUserInfo();
            
            initCreateTaskForm();
            setupFormValidation();
        });

        function updateUserInfo() {
            const userInfo = document.getElementById('userInfo');
            if (userInfo && Auth.currentUser) {
                userInfo.innerHTML = `üëã ${Auth.currentUser.name} 
                    <span style="opacity: 0.8;">(${Auth.currentUser.role === 'admin' ? '–ë—É—Ö–≥–∞–ª—Ç–µ—Ä' : '–£–ø—Ä–∞–≤–ª—è—é—â–∏–π'})</span>`;
            }
        }

        function initCreateTaskForm() {
            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ä–µ–≥–∏–æ–Ω—ã
            const regionSelect = document.getElementById('regionSelect');
            appData.regions.forEach(region => {
                const option = document.createElement('option');
                option.value = region;
                option.textContent = region;
                regionSelect.appendChild(option);
            });

            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å—Ç–∞—Ç—å–∏ —Ä–∞—Å—Ö–æ–¥–æ–≤
            const expenseSelect = document.getElementById('expenseSelect');
            appData.expenseItems.forEach(expense => {
                const option = document.createElement('option');
                option.value = expense;
                option.textContent = expense;
                expenseSelect.appendChild(option);
            });

            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∞—Ç—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–∑–∞–≤—Ç—Ä–∞)
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('plannedDate').value = tomorrow.toISOString().split('T')[0];

            // –ù–∞–∑–Ω–∞—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
            setupEventListeners();
        }

        function setupEventListeners() {
            // –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–µ–≥–∏–æ–Ω–∞
            document.getElementById('regionSelect').addEventListener('change', function() {
                updateIPsByRegion(this.value);
            });

            // –ò–∑–º–µ–Ω–µ–Ω–∏–µ –ò–ü
            document.getElementById('ipSelect').addEventListener('change', function() {
                updateCardsByIP(this.value);
            });

            // –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—å–∏ —Ä–∞—Å—Ö–æ–¥–æ–≤
            document.getElementById('expenseSelect').addEventListener('change', function() {
                updateResponsibleManager(this.value);
            });

            // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã
            document.getElementById('createTaskForm').addEventListener('submit', handleFormSubmit);
        }

        function updateIPsByRegion(region) {
            const ipSelect = document.getElementById('ipSelect');
            const cardSelect = document.getElementById('cardSelect');
            
            // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è
            ipSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ò–ü</option>';
            cardSelect.innerHTML = '<option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ò–ü</option>';
            cardSelect.disabled = true;
            document.getElementById('cardStatus').textContent = '';

            if (!region) {
                ipSelect.disabled = true;
                return;
            }

            // –ó–∞–ø–æ–ª–Ω—è–µ–º –ò–ü –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ä–µ–≥–∏–æ–Ω–∞
            const ips = appData.getIPsByRegion(region);
            ips.forEach(ip => {
                const option = document.createElement('option');
                option.value = ip;
                option.textContent = ip;
                ipSelect.appendChild(option);
            });

            ipSelect.disabled = false;
        }

        function updateCardsByIP(ip) {
            const cardSelect = document.getElementById('cardSelect');
            const cardStatus = document.getElementById('cardStatus');
            
            // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è
            cardSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ä—Ç—É</option>';
            cardStatus.textContent = '';

            if (!ip) {
                cardSelect.disabled = true;
                return;
            }

            // –ü–æ–ª—É—á–∞–µ–º –∫–∞—Ä—Ç—ã –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ò–ü
            const cards = appData.getCardsByIP(ip);
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—É—é –∫–∞—Ä—Ç—É –µ—Å–ª–∏ –µ—Å—Ç—å
            if (cards.corpCard) {
                const option = document.createElement('option');
                option.value = cards.corpCard;
                option.textContent = `üí≥ –ö–æ—Ä–ø. –∫–∞—Ä—Ç–∞ ${cards.corpCard}`;
                option.dataset.type = 'corp';
                cardSelect.appendChild(option);
            }

            // –î–æ–±–∞–≤–ª—è–µ–º –∫–∞—Ä—Ç—É –§–õ –µ—Å–ª–∏ –µ—Å—Ç—å
            if (cards.flCard) {
                const option = document.createElement('option');
                option.value = cards.flCard;
                option.textContent = `üí≥ –ö–∞—Ä—Ç–∞ –§–õ ${cards.flCard}`;
                option.dataset.type = 'fl';
                cardSelect.appendChild(option);
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å –∫–∞—Ä—Ç—ã
            if (cards.status) {
                let statusText = '';
                let statusColor = 'var(--text-light)';
                
                if (cards.status === '–≤ —Ä–µ–≥–∏–æ–Ω–µ') {
                    statusText = '‚úÖ –ö–∞—Ä—Ç–∞ –≤ —Ä–µ–≥–∏–æ–Ω–µ';
                    statusColor = 'var(--success)';
                } else if (cards.status.includes('–ü–í–ó')) {
                    statusText = `‚ö†Ô∏è ${cards.status}`;
                    statusColor = 'var(--warning)';
                } else if (cards.status === '–ü–µ—Ä–µ–≤—ã–ø—É—Å—Ç–∏—Ç—å') {
                    statusText = '‚ùå –¢—Ä–µ–±—É–µ—Ç—Å—è –ø–µ—Ä–µ–≤—ã–ø—É—Å–∫';
                    statusColor = 'var(--error)';
                }
                
                cardStatus.textContent = statusText;
                cardStatus.style.color = statusColor;
            }

            cardSelect.disabled = false;
        }

        function updateResponsibleManager(expenseItem) {
            const responsibleInput = document.getElementById('responsibleManager');
            
            if (!expenseItem) {
                responsibleInput.value = '';
                return;
            }

            const manager = appData.getManagerByExpense(expenseItem);
            responsibleInput.value = manager;
        }

        function setupFormValidation() {
            const form = document.getElementById('createTaskForm');
            
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã
                const formData = {
                    title: document.getElementById('taskTitle').value.trim(),
                    description: document.getElementById('taskDescription').value.trim(),
                    region: document.getElementById('regionSelect').value,
                    ip: document.getElementById('ipSelect').value,
                    bankCard: document.getElementById('cardSelect').value,
                    expenseItem: document.getElementById('expenseSelect').value,
                    responsibleManager: document.getElementById('responsibleManager').value,
                    plannedAmount: parseFloat(document.getElementById('plannedAmount').value),
                    plannedDate: document.getElementById('plannedDate').value,
                    priority: document.getElementById('prioritySelect').value,
                    managerComment: document.getElementById('managerComment').value.trim(),
                    status: 'pending'
                };

                // –í–∞–ª–∏–¥–∞—Ü–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π
                const requiredFields = [
                    document.getElementById('taskTitle'),
                    document.getElementById('regionSelect'),
                    document.getElementById('ipSelect'),
                    document.getElementById('cardSelect'),
                    document.getElementById('expenseSelect'),
                    document.getElementById('plannedAmount'),
                    document.getElementById('plannedDate')
                ];

                if (!FormHelper.validateRequired(requiredFields)) {
                    Notification.error('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è');
                    return;
                }

                // –í–∞–ª–∏–¥–∞—Ü–∏—è —Å—É–º–º—ã
                if (formData.plannedAmount <= 0) {
                    FormHelper.showFieldError(document.getElementById('plannedAmount'), '–°—É–º–º–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –±–æ–ª—å—à–µ 0');
                    Notification.error('–°—É–º–º–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –±–æ–ª—å—à–µ 0');
                    return;
                }

                // –°–æ–∑–¥–∞–µ–º –∑–∞–¥–∞—á—É
                handleCreateTask(formData);
            });
        }

        function handleCreateTask(taskData) {
            try {
                const newTask = TaskManager.createTask(taskData);
                
                Notification.success(`–ó–∞–¥–∞—á–∞ "${taskData.title}" —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!`);
                
                // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
                FormHelper.resetForm(document.getElementById('createTaskForm'));
                
                // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∑–∞–¥–∞—á —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
                setTimeout(() => {
                    window.location.href = 'tasks.html';
                }, 2000);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–¥–∞—á–∏:', error);
                Notification.error('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–¥–∞—á–∏');
            }
        }
    </script>
</body>
</html>