<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìã –ó–∞–¥–∞—á–∏ - IP Expense Manager</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <a href="dashboard.html" class="navbar-brand">
                    üéØ IP Expense Manager
                </a>
                <div style="display: flex; align-items: center; gap: 20px;">
                    <span style="color: white; font-size: 14px;" id="userInfo">
                        <!-- –ó–∞–ø–æ–ª–Ω–∏—Ç—Å—è —á–µ—Ä–µ–∑ JavaScript -->
                    </span>
                    <button onclick="Auth.logout()" class="btn" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); font-size: 14px;">
                        üö™ –í—ã–π—Ç–∏
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <main class="container" style="padding: 40px 20px;">
        <div class="glass-card" style="padding: 30px; margin-bottom: 30px;">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px; flex-wrap: wrap; gap: 16px;">
                <div>
                    <h1 style="margin-bottom: 8px; color: var(--primary);">üìã –í—Å–µ –∑–∞–¥–∞—á–∏</h1>
                    <p style="color: var(--text-light); margin: 0;">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á</p>
                </div>
                <div style="display: flex; gap: 16px; flex-wrap: wrap;">
                    <a href="create-task.html" class="btn btn-primary" id="createTaskButton">‚ûï –ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞</a>
                </div>
            </div>

            <div class="row">
                <div class="col-4">
                    <div class="form-group">
                        <label class="form-label">üìä –°—Ç–∞—Ç—É—Å</label>
                        <select class="form-control form-select" id="statusFilter" onchange="filterTasks()">
                            <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                            <option value="pending">‚è≥ –û–∂–∏–¥–∞–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</option>
                            <option value="in_progress">üîÑ –í —Ä–∞–±–æ—Ç–µ</option>
                            <option value="completed">‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ</option>
                            <option value="cancelled">‚ùå –û—Ç–º–µ–Ω–µ–Ω–æ</option>
                        </select>
                    </div>
                </div>
                <div class="col-4">
                    <div class="form-group">
                        <label class="form-label">üìç –†–µ–≥–∏–æ–Ω</label>
                        <select class="form-control form-select" id="regionFilter" onchange="filterTasks()">
                            <option value="">–í—Å–µ —Ä–µ–≥–∏–æ–Ω—ã</option>
                        </select>
                    </div>
                </div>
                <div class="col-4">
                    <div class="form-group">
                        <label class="form-label">üîç –ü–æ–∏—Å–∫</label>
                        <input type="text" class="form-control" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é..." onkeyup="filterTasks()">
                    </div>
                </div>
            </div>
        </div>

        <div class="glass-card animate-fade-in" style="padding: 30px;">
            <div id="tasksList">
                <div style="text-align: center; color: var(--text-light); padding: 60px;">
                    <div style="font-size: 4rem; margin-bottom: 16px;">üìã</div>
                    <p>–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–¥–∞—á...</p>
                </div>
            </div>
        </div>
    </main>

    <script src="js/data.js"></script>
    <script src="js/utils.js"></script>
    <script>
        let allTasks = [];

        document.addEventListener('DOMContentLoaded', function() {
            console.log('üìã –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–¥–∞—á –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...');
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
            Auth.init();
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
            if (!Auth.requireAuth()) return;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
            updateUserInfo();
            
            // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ø–æ —Ä–æ–ª—è–º
            setupRoleBasedUI();
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä —Ä–µ–≥–∏–æ–Ω–æ–≤
            populateRegionFilter();
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–¥–∞—á–∏
            loadTasks();
        });

        function updateUserInfo() {
            const userInfo = document.getElementById('userInfo');
            if (userInfo && Auth.currentUser) {
                userInfo.innerHTML = `üëã ${Auth.currentUser.name} 
                    <span style="opacity: 0.8;">(${Auth.currentUser.role === 'admin' ? '–ë—É—Ö–≥–∞–ª—Ç–µ—Ä' : '–£–ø—Ä–∞–≤–ª—è—é—â–∏–π'})</span>`;
            }
        }

        function setupRoleBasedUI() {
            const createTaskButton = document.getElementById('createTaskButton');
            if (createTaskButton) {
                createTaskButton.style.display = Auth.isAdmin() ? 'block' : 'none';
            }
        }

        function populateRegionFilter() {
            const regionFilter = document.getElementById('regionFilter');
            appData.regions.forEach(region => {
                const option = document.createElement('option');
                option.value = region;
                option.textContent = region;
                regionFilter.appendChild(option);
            });
        }

        function loadTasks() {
            allTasks = TaskManager.getUserTasks();
            
            if (allTasks.length === 0) {
                allTasks = [
                    {
                        id: 'demo_1',
                        title: '–ó–∞–∫—É–ø–∫–∞ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –¥–ª—è –æ—Ñ–∏—Å–∞',
                        region: '–ê—Å—Ç—Ä–∞—Ö–∞–Ω—å',
                        ip: '–ò–ü –ö—Ä—É—Ç–æ—É—Å–æ–≤',
                        expenseItem: 'üõí –ü—Ä–æ–¥—É–∫—Ç—ã',
                        responsibleManager: '–ö—Å–µ–Ω–∏—è –ë.',
                        plannedAmount: 5000,
                        status: 'pending',
                        plannedDate: '2024-01-20',
                        bankCard: '*3420',
                        description: '–ö–æ—Ñ–µ, —á–∞–π, —Å–∞—Ö–∞—Ä, –ø–µ—á–µ–Ω—å–µ, –≤–æ–¥–∞',
                        createdAt: new Date().toISOString()
                    },
                    {
                        id: 'demo_2',
                        title: '–û–ø–ª–∞—Ç–∞ –∞—Ä–µ–Ω–¥—ã –æ—Ñ–∏—Å–∞',
                        region: '–ö—É—Ä–≥–∞–Ω',
                        ip: '–ò–ü –ë–æ–Ω–¥–∞—Ä–µ–Ω–∫–æ',
                        expenseItem: 'üè¢ –ê–†–ï–ù–î–ê –û–§–ò–°–´',
                        responsibleManager: '–ï–≤–≥–µ–Ω–∏—è –ì.',
                        plannedAmount: 15000,
                        status: 'completed',
                        plannedDate: '2024-01-15',
                        bankCard: '*7254',
                        description: '–ê—Ä–µ–Ω–¥–∞ –∑–∞ —è–Ω–≤–∞—Ä—å 2024 –≥–æ–¥–∞',
                        createdAt: new Date().toISOString()
                    }
                ];
            }
            
            filterTasks();
        }

        function filterTasks() {
            const statusFilter = document.getElementById('statusFilter').value;
            const regionFilter = document.getElementById('regionFilter').value;
            const searchQuery = document.getElementById('searchInput').value.toLowerCase();
            
            let filteredTasks = allTasks.filter(task => {
                const matchesStatus = !statusFilter || task.status === statusFilter;
                const matchesRegion = !regionFilter || task.region === regionFilter;
                const matchesSearch = !searchQuery || 
                    task.title.toLowerCase().includes(searchQuery) ||
                    (task.description && task.description.toLowerCase().includes(searchQuery));
                
                return matchesStatus && matchesRegion && matchesSearch;
            });
            
            displayTasks(filteredTasks);
        }

        function displayTasks(tasks) {
            const tasksList = document.getElementById('tasksList');
            
            if (tasks.length === 0) {
                tasksList.innerHTML = `
                    <div style="text-align: center; color: var(--text-light); padding: 60px;">
                        <div style="font-size: 4rem; margin-bottom: 16px;">üîç</div>
                        <h3 style="margin-bottom: 8px;">–ó–∞–¥–∞—á–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
                        <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏</p>
                    </div>
                `;
                return;
            }
            
            tasksList.innerHTML = tasks.map(task => `
                <div class="glass-card" style="padding: 24px; margin-bottom: 20px; border-left: 4px solid ${
                    task.status === 'completed' ? 'var(--success)' : 
                    task.status === 'in_progress' ? 'var(--warning)' : 'var(--primary)'
                };">
                    <div style="display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 16px; flex-wrap: wrap; gap: 16px;">
                        <div style="flex: 1; min-width: 300px;">
                            <h3 style="margin-bottom: 8px; color: var(--text-dark);">${task.title}</h3>
                            <div style="display: flex; gap: 12px; margin-bottom: 12px; flex-wrap: wrap;">
                                <span class="badge ${task.status === 'completed' ? 'badge-success' : task.status === 'in_progress' ? 'badge-warning' : 'badge-info'}">
                                    ${TaskManager.statuses[task.status]}
                                </span>
                                <span class="badge badge-info">${task.region}</span>
                                <span class="badge" style="background: rgba(139, 92, 246, 0.1); color: var(--primary);">
                                    ${task.expenseItem}
                                </span>
                            </div>
                            <div style="color: var(--text-light); font-size: 0.9rem;">
                                <div>üíº ${task.ip} ‚Ä¢ üë§ ${task.responsibleManager}</div>
                                <div>üí≥ –ö–∞—Ä—Ç–∞: ${task.bankCard} ‚Ä¢ üìÖ ${FormatHelper.formatDate(task.plannedDate)}</div>
                                ${task.description ? `<div style="margin-top: 8px;">üìù ${task.description}</div>` : ''}
                            </div>
                        </div>
                        
                        <div style="text-align: right;">
                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary); margin-bottom: 8px;">
                                ${FormatHelper.formatAmount(task.plannedAmount)}
                            </div>
                            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                ${Auth.isAdmin() ? `
                                    <button class="btn btn-outline" style="padding: 8px 12px;" onclick="editTask('${task.id}')">
                                        ‚úèÔ∏è
                                    </button>
                                    <button class="btn btn-outline" style="padding: 8px 12px; background: rgba(239, 68, 68, 0.1); color: var(--error);" onclick="deleteTask('${task.id}')">
                                        üóëÔ∏è
                                    </button>
                                ` : ''}
                                ${Auth.isManager() && task.status !== 'completed' ? `
                                    <button class="btn btn-success" style="padding: 8px 16px;" onclick="completeTask('${task.id}')">
                                        ‚úÖ –í—ã–ø–æ–ª–Ω–∏—Ç—å
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function editTask(taskId) {
            if (!Auth.isAdmin()) {
                Notification.error('–≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º');
                return;
            }
            
            const task = allTasks.find(t => t.id === taskId);
            if (task) {
                Notification.info(`‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏: ${task.title}`);
                window.location.href = `create-task.html?edit=${taskId}`;
            }
        }

        function deleteTask(taskId) {
            if (!Auth.isAdmin()) {
                Notification.error('–≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º');
                return;
            }
            
            const task = allTasks.find(t => t.id === taskId);
            if (task && confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É "${task.title}"?`)) {
                const success = TaskManager.deleteTask(taskId);
                if (success) {
                    allTasks = allTasks.filter(t => t.id !== taskId);
                    filterTasks();
                    Notification.success('üóëÔ∏è –ó–∞–¥–∞—á–∞ —É–¥–∞–ª–µ–Ω–∞');
                } else {
                    Notification.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞–¥–∞—á–∏');
                }
            }
        }

        function completeTask(taskId) {
            const task = allTasks.find(t => t.id === taskId);
            if (task) {
                const updatedTask = TaskManager.updateTask(taskId, { 
                    status: 'completed',
                    updatedAt: new Date().toISOString()
                });
                
                if (updatedTask) {
                    task.status = 'completed';
                    filterTasks();
                    Notification.success('‚úÖ –ó–∞–¥–∞—á–∞ –æ—Ç–º–µ—á–µ–Ω–∞ –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–∞—è');
                } else {
                    Notification.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∑–∞–¥–∞—á–∏');
                }
            }
        }
    </script>
</body>
</html>